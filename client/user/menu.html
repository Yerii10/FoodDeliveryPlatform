<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>菜单 - 点餐系统</title>
  <link rel="stylesheet" href="../css/style.css" />
</head>
<body>
<div class="container">
  <div class="flex" style="justify-content:space-between;">
    <h1>选择菜品</h1>
    <div class="flex">
      <div>余额：<span id="balance" class="badge">0.00</span> 元</div>
      <a href="home.html"><button class="secondary">返回</button></a>
    </div>
  </div>

  <div id="dishList" class="grid"></div>

  <div class="card">
    <h3>购物车</h3>
    <ul id="cart" class="list"></ul>
    <div class="flex mt" style="justify-content:space-between;">
      <div>总价：<span id="total" class="badge">0.00</span> 元</div>
      <button id="submitOrder">提交订单</button>
    </div>
  </div>
</div>

<script src="../js/auth.js"></script>
<script>
const session = requireLogin("user");
if (!session) throw new Error();

const params = new URLSearchParams(location.search);
const merchant_id = Number(params.get("merchant_id"));
if (!merchant_id) { alert("缺少商家ID"); location.href = "home.html"; }

let cart = []; // {dish_id,name,price,quantity}

// === 渲染购物车 ===
function renderCart() {
  const ul = document.getElementById("cart");
  ul.innerHTML = "";
  let total = 0;
  cart.forEach((it, idx) => {
    total += it.price * it.quantity;
    const li = document.createElement("li");
    li.className = "flex";
    li.innerHTML = `
      <div style="flex:1">${it.name} × ${it.quantity}</div>
      <div>${(it.price * it.quantity).toFixed(2)} 元</div>
      <button class="secondary" data-idx="${idx}">移除</button>
    `;
    ul.appendChild(li);
  });
  document.getElementById("total").innerText = total.toFixed(2);

  // 绑定移除按钮
  [...ul.querySelectorAll("button")].forEach(btn => {
    btn.onclick = () => {
      const i = Number(btn.dataset.idx);
      cart.splice(i, 1);
      renderCart();
    };
  });
}

// === 加载菜品（仅使用商家提供的网络图片） ===
async function loadDishes() {
  const res = await fetch(`${API}/merchant/${merchant_id}/dishes`);
  const data = await res.json();
  const box = document.getElementById("dishList");
  box.innerHTML = "";

  if (!data || data.length === 0) {
    box.innerHTML = "<p>该商家暂未添加菜品</p>";
    return;
  }

  data.forEach(d => {
    const div = document.createElement("div");
    div.className = "card";

    div.innerHTML = `
      ${d.image_url ? `<img src="${d.image_url}" alt="${d.name}" 
           style="width:100%;height:150px;object-fit:cover;border-radius:8px;">` : ""}
      <h4 class="mt">${d.name}</h4>
      <div class="mt">￥${d.price}</div>
      <div class="mt">${d.description || ""}</div>
      <div class="mt flex">
        <input type="number" min="1" value="1" style="width:100px" />
        <button>加入购物车</button>
      </div>
    `;

    const qtyInput = div.querySelector("input");
    const addBtn = div.querySelector("button");
    addBtn.onclick = () => {
      const quantity = parseInt(qtyInput.value || "1");
      cart.push({ dish_id: d.id, name: d.name, price: d.price, quantity });
      renderCart();
    };
    box.appendChild(div);
  });
}

// === 提交订单 ===
document.getElementById("submitOrder").onclick = async () => {
  if (cart.length === 0) { alert("请先选择菜品"); return; }

  const payload = {
    user_id: Number(localStorage.getItem("user_id")),
    merchant_id,
    items: cart
  };

  const res = await fetch(`${API}/order/create`, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  if (data.error) { alert(data.error); return; }

  alert(`下单成功！订单号：${data.order_no}\n花费：${data.total_price} 元\n剩余余额：${data.remain_balance} 元`);
  cart = [];
  renderCart();
  await refreshBalance();
};

// 初始化
refreshBalance();
loadDishes();
renderCart();
</script>
</body>
</html>
